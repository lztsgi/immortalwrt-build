name: Build ImmortalWrt for R3S

on:
  workflow_dispatch:
    inputs:
      rootfs_size:
        description: '设定 Rootfs 根分区大小 (单位: MB，2G = 2048)'
        required: true
        default: '2048'
  schedule:
    - cron: "0 0 1,16 * *"

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-24.10
  TZ: Asia/Shanghai

jobs:
  build_r3s:
    runs-on: ubuntu-24.04
    # 授权 GITHUB_TOKEN 拥有操作 Release 和 缓存清理 的写入权限
    permissions:
      actions: write
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@main
      
    - name: Free up space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: Initialize environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update > /dev/null
        # 已修复 gawk 并补充 python3-pyelftools
        sudo -E apt-get -qq install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-setuptools python3-pyelftools rsync swig unzip zlib1g-dev file wget xz-utils > /dev/null
        sudo -E apt-get -qq autoremove --purge > /dev/null
        sudo -E apt-get -qq clean > /dev/null
        sudo timedatectl set-timezone "$TZ"

    - name: Clone source code
      run: |
        git clone $REPO_URL -b $REPO_BRANCH --single-branch --depth=1 openwrt
        echo "FILE_DATE=$(date +"%Y%m%d")" >> $GITHUB_ENV

    - name: Restore Download Cache
      uses: actions/cache/restore@v4
      with:
        path: openwrt/dl
        key: openwrt-dl-${{ github.run_id }}
        restore-keys: |
          openwrt-dl-

    - name: Update & Install feeds
      working-directory: ./openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load Config & Inject Initialization Script
      run: |
        cp armsr/armv8/R3S/.config openwrt/.config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=${{ github.event.inputs.rootfs_size }}" >> openwrt/.config
        echo "CONFIG_TARGET_ROOTFS_EXT4FS=y" >> openwrt/.config
        mkdir -p openwrt/files/etc/uci-defaults
        cp armsr/armv8/R3S/initialization.sh openwrt/files/etc/uci-defaults/99-network-init
        chmod +x openwrt/files/etc/uci-defaults/99-network-init

    - name: Download package
      working-directory: ./openwrt
      run: |
        make defconfig
        make download -j8
        find dl -size -1k -exec rm -f {} \;

    - name: Save Download Cache
      # 即使后面的编译(Compile)失败，这一步也会将下载好的包存入缓存
      uses: actions/cache/save@v4
      if: always()
      with:
        path: openwrt/dl
        key: openwrt-dl-${{ github.run_id }}

    - name: Compile R3S firmware
      working-directory: ./openwrt
      run: |
        make -j$(nproc) || make -j1 V=s

    - name: Re-compress Image to XZ
      working-directory: ./openwrt
      run: |
        cd bin/targets/rockchip/armv8/
        gunzip *sysupgrade.img.gz || true
        xz -z9 -T0 *sysupgrade.img || true

    - name: Upload R3S firmware
      uses: softprops/action-gh-release@master
      with:
        tag_name: R3S_ImmortalWrt_${{ env.FILE_DATE }}
        files: openwrt/bin/targets/rockchip/armv8/*sysupgrade.img.xz
        body: |
          NanoPi R3S 官方 ImmortalWrt 固件
          * 架构：Rockchip RK356X
          * 根分区大小：${{ github.event.inputs.rootfs_size }} MB
          * 包含智能网卡探测与初始化配置。

    - name: Cleanup Cache on Success
      # 仅在整个工作流成功完成（编译+发布无报错）时触发缓存销毁
      if: success()
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh cache delete --all || true
