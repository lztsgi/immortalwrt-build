name: Build ImmortalWrt for R3S

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 1,16 * *"

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-24.10
  TZ: Asia/Shanghai

jobs:
  build_r3s:
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout
      uses: actions/checkout@main
      
    - name: Free up space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: Initialize environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update > /dev/null
        sudo -E apt-get -qq install -y build-essential clang flex bison g++ awk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-setuptools rsync swig unzip zlib1g-dev file wget > /dev/null
        sudo -E apt-get -qq autoremove --purge > /dev/null
        sudo -E apt-get -qq clean > /dev/null
        sudo timedatectl set-timezone "$TZ"

    - name: Clone source code
      run: |
        git clone $REPO_URL -b $REPO_BRANCH --single-branch --depth=1 openwrt
        echo "FILE_DATE=$(date +"%Y%m%d")" >> $GITHUB_ENV

    - name: Update & Install feeds
      working-directory: ./openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load Config & Inject Initialization Script
      run: |
        # 1. 加载您存放在 R3S 文件夹的 .config
        cp armsr/armv8/R3S/.config openwrt/.config
        
        # 2. 创建 files 目录结构 (用于挂载开机自启脚本)
        mkdir -p openwrt/files/etc/uci-defaults
        
        # 3. 将您的 initialization.sh 复制过去，并重命名为 99-r3s-init 以确保开机自动执行
        cp armsr/armv8/R3S/initialization.sh openwrt/files/etc/uci-defaults/99-r3s-init
        
        # 4. 赋予脚本执行权限
        chmod +x openwrt/files/etc/uci-defaults/99-r3s-init

    - name: Download package
      working-directory: ./openwrt
      run: |
        make defconfig
        make download -j8
        find dl -size -1k -exec rm -f {} \;

    - name: Compile R3S firmware
      working-directory: ./openwrt
      run: |
        make -j$(nproc) || make -j1 V=s

    - name: Upload R3S firmware
      uses: softprops/action-gh-release@master
      with:
        tag_name: R3S_ImmortalWrt_${{ env.FILE_DATE }}
        files: openwrt/bin/targets/rockchip/armv8/*sysupgrade.img.gz
        body: |
          NanoPi R3S
